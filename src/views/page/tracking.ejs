<!DOCTYPE html>
<html lang="en">

<head>

    <%- include('../partials/head.ejs') %>
    <link rel="stylesheet" href="/toastr/toastr.min.css"> <!-- tiene que despues del CDN de bootstrap -->
    <script src="/toastr/toastr.min.js"></script>
    <title>Blissenet Tracking</title>

</head>
<style>


    .toast-success {
        /* Esta clase es unicamente para dar color al alert toastr de tipo success que debe ser violeta */
        background-color: #6f42c1; /* Azul tirando a morado */
        color: white; /* Color del texto */
    } 

    .textLight{
    /* trabaja en conjunto con themaTextLight */
    color: white;
    }

    .pount{
        width: 20px;
        height: 20px;
        border-radius: 50%;
        outline: 2px solid gainsboro;
    }

    @media screen and (min-width: 290px) and (max-width: 499px ){

    
    }

</style>

<body class="mainTheme" style="max-width: 100vw; min-height: 100vh;">
    <main class="themaTextLight" style="max-width: 100% !important;">

        <%- include('../partials/navi-simple.ejs') %>

        
        <%# if (catchError){ %>
            <%#- include('../alert/catchError.ejs') %> 
        <%# }; %>


        <% if (user) { %>

            <% const seeMarket = user.seeMarket %>
            <% const idUser = user._id %>
            <input type="hidden" value="<%= seeMarket.countryMarketCode %>" id="seeMarket">
            <input type="hidden" value="<%= idUser %>" id= "idUser">
            <!-- este bloque me permite validad si el usuario que se logea tiene un meercado definido. sino lo tiene debe obligatoriamente hacerlo. --> 

            <div class="container-fluid d-flex justify-content-start py-2" style="background: linear-gradient(90deg, rgba(146,0,255,1) 0%, rgba(174,65,255,1) 50%, rgba(13,110,253,1) 100%);">
                <span class="ms-2 p-0" style="font-weight: 400; color: #ffde00;"> <b> Tracking </b>  </span>
            </div>    
            
            <div class="container-fluid p-0">
                            
            
                <div class="ShoppingCart-Admin p-0">
                        
                    <% const username = user.username %>
                    <% const indexed = user._id %> <!-- esto es igual al id user -->

                    <% if (searchProfile) {  %> <!-- cuenta con perfil -->
                        
                        <div class="content_search">

                            <div class="row d-flex justify-content-around m-0 " style="background-color:rgba(217, 223, 223, 0.2);">
                
                                <div class="col-lg-4 col-md-4 col-sm-12 col-12 p-0 my-4 rounded-2"  style="background-color: rgba(209, 209, 209, 0.2)">

                                    <div class="contentainer-fluid">

                                            
                                        <div class="card-header">
                                            <span style="font-size: 18px;">Estatus de tu Compra</span>
                                        </div>
                                        <div class="card-body">

                                            <div class="requests mb-3">
                                                <span style="font-size: 16px;"> Solicitudes:  <span class="bg-secondary text-light rounded-3 px-2 ms-3"> <%= sumCount %> </span>   </span> 
                                            </div>
                                            

                                            <% if (sumCount !==0){ %>

                                                
                                                    <% shoppingCartPending.forEach((ele)=>{  %>
                                                        <% const iDCart = ele._id %>
                                                        <% const sellerName = ele.sellerName %>
                                                        <% const customerName = ele.customerName %>
                                                        <% const date = ele.date %>
                                                        <% const amount = ele.amount %>
                                                        <% const boxShoppingCart = ele.boxShoppingCart %>
                                                        <% const purchaseReceiver = ele.purchaseReceiver %>
                                                        <% const deliveryOptions = ele.deliveryOptions %>
                                                        <% const consolidate = ele.consolidate %>
                                                        <% const paid = ele.paid %>
                                                        <% const sent = ele.sent %>
                                                        <% const received = ele.received %>
                                                        <% const commentRatingSell = ele.CommentSeller %>                                                       

                                                        
                                                        <div class="listCart d-flex justify-content-between border rounded-2 mb-1 cursor-pointer" style="font-size: 16px;">
                                                            <input type="hidden" class="iDCart" value="<%= iDCart %>"> 
                                                            <input type="hidden" class="sellerNameData" value="<%= sellerName %>">
                                                            <input type="hidden" class="customerNameData" value="<%= customerName %>">
                                                            <input type="hidden" class="amount" value="<%= amount %>">  
                                                            <input type="hidden" class="boxShoppingCartData" value="<%=  JSON.stringify(boxShoppingCart) %>">
                                                            <input type="hidden" class="purchaseReceiverData" value="<%=  JSON.stringify(purchaseReceiver) %>"> 
                                                            <input type="hidden" class="deliveryOptions" value="<%= deliveryOptions %>">
                                                            <input type="hidden" class="consolidate" value="<%= consolidate %>">
                                                            <input type="hidden" class="paid" value="<%= paid %>">
                                                            <input type="hidden" class="sent" value="<%= JSON.stringify(sent) %>">
                                                            <input type="hidden" class="received" value="<%= received %>">
                                                            <input type="hidden" class="commentRatingSell" value="<%= commentRatingSell %>">

                                                            <div class="listLeft">
                                                                <img src="/img/iconCartBuyes.png" alt="" style="width: 35px; height: 35px;">
                                                                <span class="me-1"><%= sellerName  %></span> <span class="px-2 rounded-3" style="white-space: nowrap"> <i class="bi bi-currency-dollar"></i>(<%= amount  %>)</span> 
                                                            </div> 

                                                            <div class="listRight d-flex align-items-center">
                                                                <span class="me-2 bg-light rounded-3 px-2 text-dark shadow-sm" style="font-size: 14px; white-space: nowrap">
                                                                   <i><%= date %></i> 
                                                                </span>
                                                            </div>
                                                            
                                                        </div>    
                                                    <% }); %>    
                                                  
                                         
                                            <% } else { %>
                                                <span class="rounded-3 p-2" style="background-color: rgba(0, 0, 0, 0.1);">No hay carritos pendientes</span>
                                            <% }; %>    

                                        
                                        </div>
                                        
                                        <div class="form-group px-3 mt-4 mb-2">
                                            <a class="form-control btn btn-primary" href="/payShoppingCart">Gestión de Carritos de Compra</a>
                                        </div>      
                        
                                    </div>

                                </div>

                                <div class="col-lg-7 col-md-7 col-sm-12 col-12 p-0 my-4 rounded-2"  style="background-color: rgba(209, 209, 209, 0.2)">

                                    <div class="contentainer-fluid">


                                            <div class="card-header">
                                               <span style="font-size: 18px;"> Tracking </span>
                                            </div>    
                                            <div class="card-body">

                                                <% if (sumCount !==0){ %>
                                                    <div class="containerAlertSelect">
                                                        <div class="alert" style="background-color: rgb(0, 0, 0, 0.1); font-size: 16px;">
                                                            <p>¡ Seleccione un carrito de compra !</p>
                                                        </div>
                                                    </div>
                                                <% } else { %>
                                                    <div class="containerImageSinResultados d-flex justify-content-center p-5">
                                                        <img src="/img/sinResultados.png" style="width: 200px;">
                                                    </div>
                                                <% }; %>  

                                                <div class="CUSTOMERName rounded-3 text-light mb-2" style="font-size: 18px;">
                                                    <!-- dato inyectado dinamicamente -->
                                                </div>

                                                <div class="listStep flex-column" style="font-size: 18px;">
                                                    <div class="step d-flex my-3 align-items-center" id="consolidateInner">
                                                        <!-- dinamico -->
                                                    </div>
                                                    <div class="step d-flex my-3 align-items-center" id="paidInner">
                                                        <!-- dinamico -->
                                                    </div>
                                                    <div class="step d-flex my-3 align-items-center" id="sentInner">
                                                        <!-- dinamico -->
                                                    </div>  
                                                    <div class="step d-flex my-3 align-items-center" id="receivedInner">
                                                        <!-- dinamico -->
                                                    </div>
                                                    <div class="step d-flex my-3 align-items-center" id="rateCommentInner">
                                                        <!-- dinamico -->
                                                    </div>
                                                </div>


                                                <div class="contentClientData close">
                                                    <div class="form-group my-2 d-flex flex-wrap" style="font-size: 16px;">
                                                        <span class="me-2 rounded-pill px-3 py-2 mb-2" style="background-color: rgba(0, 0, 0, 0.1); white-space: nowrap;"> <b>Nombre: </b> <span class="clientNames"></span>  </span> 
                                                        <span class="me-2 rounded-pill px-3 py-2 mb-2" style="background-color: rgba(0, 0, 0, 0.1); white-space: nowrap;"> <b>Documento: </b> <span class="clientDocument"></span> </span>
                                                        <span class="me-2 rounded-pill px-3 py-2 mb-2" style="background-color: rgba(0, 0, 0, 0.1); white-space: nowrap;"> <b>Teléfono:</b> <span class="clientPhone"></span> </span>
                                                    </div>

                                                    <div class="form-group my-0 px-3 py-2 mb-3" style="font-size: 16px; background-color: rgba(0, 0, 0, 0.1); width: auto; border-radius: 10px;">
                                                        <span style="white-space: 16px;"> <b>Dirección:</b> <span class="clientAddress"></span> </span>
                                                    </div>

                                                    <div class="containerDelivery form-group my-0 px-3 py-2 mb-3 close" style="font-size: 16px; background-color: rgba(0, 0, 0, 0.1); width: auto; border-bottom-left-radius: 0; border-bottom-right-radius: 0; border-top-left-radius: 9px; border-top-right-radius: 9px;">
                                                        <span style="white-space: 16px;"> <b>Delivery:</b> </span> <span class="delivery bg-secondary text-light rounded-pill ms-1 px-3 py-1" style="white-space: nowrap;"> </span> 
                                                    </div> 
                                                </div>
                                            </div>
                        
                                    </div>

                                </div>

                            </div>

                        </div>  


                        <div class="card mt-1" style="background-color:rgba(217, 223, 223, 0.2);">
                            <div class="card-body d-flex justify-content-center ">
                                <a href="/" class="text-decoration-none" style="color: inherit">  <span id="logoBlissenet_com"> </span> </a> 
                            </div>
                        </div>
                        
                        <!-- Modal Shopping-cart --> <!--lo activa > data-bs-toggle="modal" data-bs-target="#staticSuicheSegment" -->
                        <div class="modal fade" id="staticCheckSearch" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabelH2" aria-hidden="true">
                            <div class="modal-dialog border border-secondary p-2 rounded-3" style="background-color: rgb(0, 0, 0, 0.3);">
                                <div class="modal-content text-dark">

                                    <div class="modal-header">
                                        <h5 class="modal-title" id="staticBackdropLabelH2">Carrito de Compras</h5>
                                        <i class="bi bi-x-lg cursor-pointer" data-bs-dismiss="modal"></i>
                                    </div>
                                    <div class="modal-body">
                                        <p><span class="fw-bold text-primary">Agrega un Carrito de Compras. </span>
                                            "¡Aprovecha esta función para facilitar las compras de tus clientes!, ofrece esta herramienta para que puedan
                                                hacer una compra de varios articulos con un solo pago."
                                        </p>
                                        <p> <span class="bg-dark py-1 px-2 rounded-2"> <b class="text-info">Requerimento : + 1 Anuncios</b>  </span> </p>
                                    </div>
                                    <div class="modal-footer" style="background-image: url('/img/bannerShoopingCart.jpg'); background-size: cover; background-position: center;">
                                        <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Cerrar</button>
                                    </div>
                                </div>
                            </div>
                        </div> 
                        
                    <% } else { %> <!-- cuenta sin perfil -->

                    <% } %>                                                        

                                    
                </div>
    

            </div>



         <% } else { %>
            <div class="container-fluid d-flex justify-content-center p-3" style="height: 90%; width: 100%; background-color:  rgb(243, 238, 238); box-shadow: 1px 1px 5px 1px rgb(99, 98, 98);  border-top: 2px ridge  rgb(243, 238, 238);">
               
                <%- include('../partials/noLogin.ejs') %>

            </div>  
         <% }; %>

    </main>
        <%- include('../partials/scripts.ejs') %>
        <%- include('../partials/scriptsOnlyNavi-simpleNoIcons.ejs') %>
        <!-- este cnd es el constructor de QR  se encuentra en https://cdnjs.com/libraries/qrious -->
        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script> esta sirve tambien pero deje la de abajo, no se cual es la diferencia entre ambas pero este es la cdn para crear los QR-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" integrity="sha512-pUhApVQtLbnpLtJn6DuzDD5o2xtmLJnJ7oBoMsBnzOkVkpqofGLGPaBJ6ayD2zQe3lCgCibhJBi4cj5wAxwVKA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
       

</body>


<script>
    const listCart = document.querySelectorAll('.listCart');
    const iDCart = document.querySelectorAll('.iDCart');
    const sellerNameData = document.querySelectorAll('.sellerNameData');
    const customerNameData = document.querySelectorAll('.customerNameData');
    const amount = document.querySelectorAll('.amount');
    const boxShoppingCartData = document.querySelectorAll('.boxShoppingCartData'); 
    const purchaseReceiverData = document.querySelectorAll('.purchaseReceiverData');
    const deliveryOption = document.querySelectorAll('.deliveryOptions');
    const consolidateData = document.querySelectorAll('.consolidate'); // "true" or "false"
    const paidData = document.querySelectorAll('.paid'); // "true" or "false"
    const sentData = document.querySelectorAll('.sent'); // Esto es un objeto de dos campos sentStatus y sentDetails
    const receivedData = document.querySelectorAll('.received'); // "true" or "false"
    const commentRatingSellData = document.querySelectorAll('.commentRatingSell'); // 

    const controlReceived = document.querySelector('.controlReceived');

    //para inyectar  
    const CUSTOMERName = document.querySelector('.CUSTOMERName');
    const listShoppingCart = document.querySelector('.listShoppingCart');
    const totalPayDinamic = document.querySelector('.totalPayDinamic');

    const containerAlertSelect = document.querySelector('.containerAlertSelect');
    const contentClientData = document.querySelector('.contentClientData');
    const clientNamesSpan = document.querySelector('.clientNames');
    const clientDocumentSpan = document.querySelector('.clientDocument');
    const clientPhoneSpan = document.querySelector('.clientPhone');
    const clientAddressSpan = document.querySelector('.clientAddress');
    const deliverySpan = document.querySelector('.delivery');

    const consolidateInner = document.getElementById('consolidateInner');
    const paidInner = document.getElementById('paidInner');
    const sentInner = document.getElementById('sentInner');
    const receivedInner = document.getElementById('receivedInner');
    const rateCommentInner = document.getElementById('rateCommentInner');
    
    let IDCart;

    listCart.forEach((ele, i)=>{

        console.log("esto es ele ----->", ele)
        ele.addEventListener('click', ()=>{
            //console.log("Valor del id del carrito :", ele);
            //console.log(iDCart[i].value);
            IDCart = iDCart[i].value;
            const sellerName = sellerNameData[i].value;
            const clientName = customerNameData[i].value;
            const receiverTxt = purchaseReceiverData[i].value; 
            const receiver = JSON.parse(receiverTxt);
            const Amount = amount[i].value;
            const deliveryOpt = deliveryOption[i].value; 
            const ConsolidateData = consolidateData[i].value;
            const PaidData = paidData[i].value;
            const SentData =  JSON.parse (sentData[i].value);
            const ReceivedData = receivedData[i].value;
            const CommentRatingSellData = commentRatingSellData[i].value;
            
            console.log("-------------------ver--------------------")
            console.log("clientName.....:", clientName);
            //console.log("receiver.....:", receiver);
            //console.log("ConsolidateData.....:", ConsolidateData);
            //console.log("PaidData.....:", PaidData);
            //console.log("SentData.....:", SentData);
            //console.log("SentData.sentStatus :", SentData.sentStatus);
            //console.log("SentData.sentDetails :", SentData.sentDetails);
            console.log("CommentRatingSellData....:", CommentRatingSellData);
            console.log("IDCart...........", IDCart);
            //console.log("ReceivedData..............:", ReceivedData);

            const clientNames = receiver.clientName;
            const clientIndentification = receiver.clientIndentification;
            const clientPhone = receiver.clientPhone;
            const clientAddress = receiver.clientAddress; 
            //aqui ahora inyectamos los datos ...................................................

            CUSTOMERName.innerHTML =   `<div class="bg-light rounded-pill text-secondary" style="height: auto; width: auto">        
                                            <img src="/img/iconCartBuyes.png" alt="" style="width: 30px; height: 30px;">
                                            <span class="ms-2"> <b> ${sellerName} </b>  </span>
                                            <span class="ms-2 text-secondary" style="font-size : 15px">  <b> <i class="bi bi-currency-dollar"></i>  ${Amount}  </b>  </span>
                                        </div>`

            if (ConsolidateData === "true"){

                consolidateInner.innerHTML = `
                                                <div class="pount bg-primary ms-2"></div>
                                                <div class="ms-1" style="flex: 1; position: relative;">
                                                    <div style="position: absolute; top: 50%; left: 0; right: 0; border-bottom: 2px solid #007bff; transform: translateY(-50%);"></div>
                                                </div>
                                                <span class="mx-2">Consolidado</span>                                
                                            `
            } else {

                consolidateInner.innerHTML = `
                                                <div class="pount bg-secondary ms-2"></div>
                                                <div class="ms-1" style="flex: 1; position: relative;">
                                                    <div style="position: absolute; top: 50%; left: 0; right: 0; border-bottom: 2px solid #6c757d; transform: translateY(-50%);"></div>
                                                </div>
                                                <span class="mx-2">Consolidado</span>                              
                                            `

            }

            if (PaidData === "true") {

                paidInner.innerHTML = `
                                            <div class="pount bg-primary ms-2"></div>
                                            <div class="ms-1" style="flex: 1; position: relative;">
                                                <div style="position: absolute; top: 50%; left: 0; right: 0; border-bottom: 2px solid #007bff; transform: translateY(-50%);"></div>
                                            </div>
                                            <span class="mx-2">Pagado</span>
                                            `

            } else {

                paidInner.innerHTML = `
                                            <div class="pount bg-secondary ms-2"></div>
                                            <div class="ms-1" style="flex: 1; position: relative;">
                                                <div style="position: absolute; top: 50%; left: 0; right: 0; border-bottom: 2px solid #6c757d; transform: translateY(-50%);"></div>
                                            </div>
                                            <span class="mx-2">Pagado</span>                              
                                        `

            }

            if (SentData.sentStatus === "true"){

                sentInner.innerHTML = `     
                                            <div class="pount bg-primary ms-2"></div>
                                            <div class="ms-1" style="flex: 1; position: relative;">
                                                <div style="position: absolute; top: 50%; left: 0; right: 0; border-bottom: 2px solid #007bff; transform: translateY(-50%);"></div>
                                            </div>
                                            <span class="mx-2">Enviado</span>
                                        `
        
            } else {

                sentInner.innerHTML = `
                                            <div class="pount bg-secondary ms-2"></div>
                                            <div class="ms-1" style="flex: 1; position: relative;">
                                                <div style="position: absolute; top: 50%; left: 0; right: 0; border-bottom: 2px solid #6c757d; transform: translateY(-50%);"></div>
                                            </div>
                                            <span class="mx-2">Enviado</span>                              
                                        `

            }

            if (ReceivedData === "true"){

                receivedInner.innerHTML = `     
                                            <div class="pount bg-primary ms-2"></div>
                                            <div class="ms-1" style="flex: 1; position: relative;">
                                                <div style="position: absolute; top: 50%; left: 0; right: 0; border-bottom: 2px solid #007bff; transform: translateY(-50%);"></div>
                                            </div>
                                            <span class="mx-2">Recibido</span>
                                        `

            } else {

                receivedInner.innerHTML = `
                                            <div class="pount bg-secondary ms-2"></div>
                                            <div class="ms-1" style="flex: 1; position: relative;">
                                                <div style="position: absolute; top: 50%; left: 0; right: 0; border-bottom: 2px solid #6c757d; transform: translateY(-50%);"></div>
                                            </div>
                                            <span class="mx-2">Recibido</span>                              
                                        `

            }
         
            if (CommentRatingSellData !== "no_comment" ){

                rateCommentInner.innerHTML = `     
                                            <div class="pount bg-primary ms-2"></div>
                                            <div class="ms-1" style="flex: 1; position: relative;">
                                                <div style="position: absolute; top: 50%; left: 0; right: 0; border-bottom: 2px solid #007bff; transform: translateY(-50%);"></div>
                                            </div>
                                            <span class="mx-2">Comentado y Calificado</span>
                                        `
            } else {


                rateCommentInner.innerHTML = `
                                            <div class="pount bg-secondary ms-2"></div>
                                            <div class="ms-1" style="flex: 1; position: relative;">
                                                <div style="position: absolute; top: 50%; left: 0; right: 0; border-bottom: 2px solid #6c757d; transform: translateY(-50%);"></div>
                                            </div>
                                            <span class="mx-2">Comentado y Calificado</span>                              
                                        `

            }

            containerAlertSelect.classList.add('close');
            contentClientData.classList.remove('close');
            
            clientNamesSpan.innerText = clientNames;
            clientDocumentSpan.innerText = clientIndentification;
            clientPhoneSpan.innerText = clientPhone;
            clientAddressSpan.innerText = clientAddress;
        })    
    

    })



</script>


<script>


    function mostrarToast(mensaje, posicion, color, titulo = '', conBotonCerrar = false) {
        // Configuración predeterminada
        toastr.options = {
            "closeButton": conBotonCerrar, // Agregar botón de cerrar si se solicita
            "debug": false,
            "newestOnTop": false,
            "progressBar": !conBotonCerrar, // Si tiene botón de cerrar, no mostrar barra de progreso
            "preventDuplicates": false,
            "onclick": null,
            "showDuration": "600",
            "hideDuration": "1000",
            "timeOut": conBotonCerrar ? false : "8000", // No se oculta automáticamente si tiene botón de cerrar
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        };
  
        // Configurar la posición
        switch (posicion) {
            case 'center':
                toastr.options.positionClass = 'toast-top-center';
                break;
            case 'left':
                toastr.options.positionClass = 'toast-top-left';
                break;
            case 'right':
                toastr.options.positionClass = 'toast-top-right';
                break;
            default:
                toastr.options.positionClass = 'toast-top-right'; // Posición predeterminada
        }
  
        // Mostrar el mensaje según el color especificado
        switch (color) {
            case 'success':
                titulo ? toastr.success(mensaje, titulo) : toastr.success(mensaje);
                break;
            case 'info':
                titulo ? toastr.info(mensaje, titulo) : toastr.info(mensaje);
                break;
            case 'warning':
                titulo ? toastr.warning(mensaje, titulo) : toastr.warning(mensaje);
                break;
            case 'danger':
                titulo ? toastr.error(mensaje, titulo) : toastr.error(mensaje);
                break;
            case 'primary':
                titulo ? toastr.info(mensaje, titulo, { toastClass: 'toast-primary' }) : toastr.info(mensaje, '', { toastClass: 'toast-primary' });
                break;
            case 'dark':
                titulo ? toastr.info(mensaje, titulo, { toastClass: 'toast-dark' }) : toastr.info(mensaje, '', { toastClass: 'toast-dark' });
                break;
            default:
                console.warn('Color no válido. Usando el color por defecto (success).');
                titulo ? toastr.success(mensaje, titulo) : toastr.success(mensaje);
        }
    }
  
    //mostrarToast( response , 'right', 'danger', '', true ); // Agrega título aquí
  
</script>


